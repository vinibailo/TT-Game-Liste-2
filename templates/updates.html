<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="page-updates">
    <div id="toast" role="status" aria-live="polite"></div>
    <header class="app-topbar" aria-label="Primary navigation">
        <div class="topbar-content">
            <a class="topbar-brand" href="{{ url_for('web.index') }}">Game Editor</a>
            <nav class="topbar-nav" aria-label="Global">
                <a class="topbar-link" href="{{ url_for('web.index') }}">Editor</a>
                <a class="topbar-link is-active" href="{{ url_for('updates.updates_page') }}">Update</a>
                <a class="topbar-link" href="{{ url_for('lookups.lookups_page') }}">Lookups</a>
                <a class="topbar-link" href="{{ url_for('web.logout') }}">Logout</a>
            </nav>
        </div>
    </header>
    <main class="updates-page">
        <header class="updates-header">
            <div class="updates-title">
                <h1>Update</h1>
                <p>Monitor pending changes from IGDB before applying them to the local catalog.</p>
            </div>
            <div class="updates-actions">
                <label class="updates-search search-field" for="updates-search">
                    <span class="sr-only">Search updates</span>
                    <input
                        type="search"
                        id="updates-search"
                        placeholder="Search by game, ID or IGDB ID"
                        autocomplete="off"
                        class="search-input"
                        data-search
                    />
                </label>
                <div class="updates-bulk-action">
                    <button type="button" class="btn btn-blue" data-refresh>
                        <span class="btn-icon" aria-hidden="true">
                            <span class="material-symbols-rounded">refresh</span>
                        </span>
                        <span class="btn-label">Update</span>
                    </button>
                    <div class="progress-indicator updates-progress" data-refresh-progress hidden>
                        <div class="progress-metrics">
                            <span class="progress-count" data-refresh-count>0/0</span>
                            <span class="progress-percent" data-refresh-percent>0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" data-refresh-bar></div>
                        </div>
                    </div>
                </div>
                <div class="updates-bulk-action">
                    <button type="button" class="btn btn-green" data-fix-names>
                        <span class="btn-icon" aria-hidden="true">
                            <span class="material-symbols-rounded">spellcheck</span>
                        </span>
                        <span class="btn-label">Fix IGDB Names</span>
                        <span class="sr-only">Fix processed game names using IGDB data</span>
                    </button>
                    <div class="progress-indicator updates-progress" data-fix-progress hidden>
                        <div class="progress-metrics">
                            <span class="progress-count" data-fix-count>0/0</span>
                            <span class="progress-percent" data-fix-percent>0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" data-fix-bar></div>
                        </div>
                    </div>
                </div>
                <div class="updates-bulk-action">
                    <button type="button" class="btn btn-red" data-remove-duplicates>
                        <span class="btn-icon" aria-hidden="true">
                            <span class="material-symbols-rounded">layers_clear</span>
                        </span>
                        <span class="btn-label">Remove Duplicates</span>
                        <span class="sr-only">Remove unprocessed duplicate IGDB entries</span>
                    </button>
                    <div class="progress-indicator updates-progress" data-dedupe-progress hidden>
                        <div class="progress-metrics">
                            <span class="progress-count" data-dedupe-count>0/0</span>
                            <span class="progress-percent" data-dedupe-percent>0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" data-dedupe-bar></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <section class="updates-summary" aria-live="polite">
            <span>Total entries:</span>
            <strong data-count>0</strong>
            <span class="updates-status" data-refresh-status></span>
        </section>
        <section class="updates-table-card">
            <div class="table-scroll" role="region" aria-live="polite" aria-label="Updates table">
                <table class="updates-table">
                    <thead>
                        <tr>
                            <th scope="col" data-sortable aria-sort="descending">
                                <button type="button" class="sort-button" data-sort="refreshed_at">
                                    <span>Refreshed</span>
                                    <span class="sort-indicator material-symbols-rounded" aria-hidden="true">arrow_downward</span>
                                </button>
                            </th>
                            <th scope="col" data-sortable aria-sort="none">
                                <button type="button" class="sort-button" data-sort="name">
                                    <span>Game</span>
                                    <span class="sort-indicator material-symbols-rounded" aria-hidden="true">unfold_more</span>
                                </button>
                            </th>
                            <th scope="col" data-sortable aria-sort="none">
                                <button type="button" class="sort-button" data-sort="processed_game_id">
                                    <span>Game ID</span>
                                    <span class="sort-indicator material-symbols-rounded" aria-hidden="true">unfold_more</span>
                                </button>
                            </th>
                            <th scope="col">IGDB ID</th>
                            <th scope="col">IGDB Updated</th>
                            <th scope="col">Local Edited</th>
                            <th scope="col" class="actions-column">Actions</th>
                        </tr>
                    </thead>
                    <tbody data-updates-body></tbody>
                </table>
            </div>
            <nav class="table-pagination" data-pagination hidden aria-label="Pagination">
                <button type="button" class="pagination-button" data-page-prev aria-label="Previous page">
                    <span class="material-symbols-rounded" aria-hidden="true">chevron_left</span>
                    <span class="pagination-label">Previous</span>
                </button>
                <div class="pagination-info" data-page-info>Page 1 of 1</div>
                <button type="button" class="pagination-button" data-page-next aria-label="Next page">
                    <span class="material-symbols-rounded" aria-hidden="true">chevron_right</span>
                    <span class="pagination-label">Next</span>
                </button>
            </nav>
            <div class="table-empty" data-empty-state hidden>
                <p>No updates found. Try refreshing or adjust your search.</p>
            </div>
            <div class="table-loading" data-loading-state hidden>
                <span class="material-symbols-rounded" aria-hidden="true">hourglass_empty</span>
                <p>Loading updatesâ€¦</p>
            </div>
        </section>
    </main>
    <div class="modal-backdrop hidden" data-modal hidden>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="diff-modal-title">
            <header class="modal-header">
                <div class="modal-titles">
                    <h2 id="diff-modal-title">Update details</h2>
                    <p class="modal-subtitle" data-modal-subtitle></p>
                </div>
                <button type="button" class="icon-button" data-close-modal aria-label="Close dialog">
                    <span class="material-symbols-rounded" aria-hidden="true">close</span>
                </button>
            </header>
            <div class="modal-overview">
                <div class="modal-cover">
                    <img data-modal-cover alt="" />
                </div>
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">Game ID</span>
                        <span class="meta-value" data-modal-game-id></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">IGDB ID</span>
                        <span class="meta-value" data-modal-igdb-id></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">IGDB Updated</span>
                        <span class="meta-value" data-modal-igdb-updated></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Local Edited</span>
                        <span class="meta-value" data-modal-local-edited></span>
                    </div>
                </div>
            </div>
            <div class="modal-body" data-modal-body>
                <p class="modal-empty" data-modal-empty hidden>No differences were recorded for this game.</p>
                <div class="diff-list" data-diff-list></div>
            </div>
        </div>
    </div>
    <script>
        window.updatesConfig = {
            editBaseUrl: {{ url_for('web.index')|tojson }},
            updatesUrl: {{ url_for('updates.api_updates_list')|tojson }},
            refreshUrl: {{ url_for('updates.api_updates_refresh')|tojson }},
            cacheRefreshUrl: {{ url_for('updates.api_igdb_cache_refresh')|tojson }},
            fixNamesUrl: {{ url_for('updates.api_updates_fix_names')|tojson }},
            removeDuplicatesUrl: {{ url_for('updates.api_updates_remove_duplicates')|tojson }},
            deleteDuplicateUrlTemplate: {{ url_for('updates.api_updates_remove_duplicate', processed_game_id=0)|replace('0', '{id}')|tojson }},
            jobsUrl: {{ url_for('updates.api_updates_job_list')|tojson }},
            jobDetailUrlTemplate: {{ url_for('updates.api_updates_job_detail', job_id='job')|replace('job', '{id}')|tojson }},
            detailUrlTemplate: {{ url_for('updates.api_updates_detail', processed_game_id=0)|replace('0', '{id}')|tojson }},
            coverUrlTemplate: {{ url_for('updates.api_updates_cover', processed_game_id=0)|replace('0', '{id}')|tojson }},
            cacheBatchSize: {{ igdb_batch_size|tojson }},
            fixBatchSize: {{ FIX_NAMES_BATCH_LIMIT|default(50)|tojson }}
        };
    </script>
    <script src="{{ url_for('static', filename='updates.js') }}" defer></script>
</body>
</html>
